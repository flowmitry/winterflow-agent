---
description: 
globs: internal/infra/winterflow/grpc/**
alwaysApply: false
---
# Agent ID Validation for Incoming gRPC Commands

When you add or modify logic that handles `ServerCommand` messages received over the bidirectional stream, **always validate** that the `agent_id` contained in the embedded `BaseMessage` matches the local agent's ID.

* Use `ValidateAndRespondAgentID` from `internal/infra/winterflow/grpc/client/utils.go` to perform this check.
* If the IDs do not match, the helper will automatically send a `RESPONSE_CODE_UNAUTHORIZED` response and the command **must be ignored**.
* Do **not** process any command before this validation succeeds.

Example (inside the stream-receiver loop):
```go
if !ValidateAndRespondAgentID(stream, serverCmd.Command, agentID) {
    continue // mismatched agent, command ignored
}
```

Following this rule ensures that the agent never executes commands intended for a different agent instance.
